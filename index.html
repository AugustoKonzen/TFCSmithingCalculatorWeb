<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actions Sequence</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
</head>
<body>
    <div class="global-container">
        <h1>TFC Smithing Calculator</h1>
        <h2>Forging Process ðŸ”¨</h2>

        <button id="howToUseBtn" class="tutorial-btn">How to Use</button>

        <div id="tutorialModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>How to Use</h2>
        
                <!-- Smithing Section -->
                <h3>Forging Process ðŸ”¨</h3>
                <img src="img/start_forging.png" alt="Forging Start" class="tutorial-img">
                <p>
                    Before starting the forging process, you must align the two indicators shown in the red circles. 
                    Regardless of the selected sequence, forging will fail if these points are not aligned.
                </p>
        
                <img src="img/points_aligned.png" alt="Aligned Points" class="tutorial-img">
                <p>
                    Once the two indicators are perfectly aligned, you can follow the calculated sequence step by step.
                    The system determines the optimal order of actions required to forge the item successfully.
                </p>
        
                <img src="img/output.png" alt="Calculated Sequence" class="tutorial-img">
                <p>
                    Select the exact same actions as shown in the game, align the points, and apply the sequence 
                    generated by this system. If followed correctly, the forging process will succeed.
                </p>

                <div class="section-divider"></div>
        
                <!-- Alloy Section -->
                <h3>Alloy Calculator ðŸ”¥</h3>
                <img src="img/alloy_calculator.png" alt="Alloy Calculator" class="tutorial-img">
                <p>
                    The Alloy Calculator helps you determine the total number of ingots produced and the metal composition 
                    based on the ingots you use in the melting process.
                </p>
                <p>
                    <strong>Important:</strong> This tool calculates <u>ingots</u>, not the raw ore pieces that you mine in the game.
                </p>
                <p>
                    When mining ores like Malachite (for copper), you obtain ore chunks, which can be Poor, Normal, or Rich quality.
                    Each piece provides different amounts of molten metal. The melting process requires gathering enough metal from 
                    these pieces to form full ingots.
                </p>
                <p>
                    Use this calculator to determine the final ingot composition once you have the required number of ingots.
                </p>
            </div>
        </div>

        <div class="container">
            <div class="action-box">
                <img src="" alt="" id="thirdImg">
                <select name="thirdAction" id="thirdAction"></select>
            </div>

            <div class="action-box">
                <img src="" alt="" id="secondImg">
                <select name="secondAction" id="secondAction"></select>
            </div>

            <div class="action-box">
                <img src="" alt="" id="firstImg">
                <select name="firstAction" id="firstAction"></select>
            </div>
        </div>

        <button id="runSequence">Calculate Sequence</button>
        <pre id="output"></pre>

        <h2>Alloy Calculator ðŸ”¥</h2>

        <div class="alloy-container">
            <h3>Metal Alloy Composition</h3>
            <p>Enter the number of ingots used for each metal to calculate the alloy composition.</p>

            <div class="ingot-inputs">
                <div>
                    <label for="ingot1">Ingot 1:</label>
                    <input type="number" id="ingot1" min="0" value="0">
                </div>
                <div>
                    <label for="ingot2">Ingot 2:</label>
                    <input type="number" id="ingot2" min="0" value="0">
                </div>
                <div>
                    <label for="ingot3">Ingot 3:</label>
                    <input type="number" id="ingot3" min="0" value="0">
                </div>
                <div>
                    <label for="ingot4">Ingot 4:</label>
                    <input type="number" id="ingot4" min="0" value="0">
                </div>
            </div>
            
            <button id="calculateAlloy">Calculate Alloy</button>
            <p id="errorMessage" class="error-message">Please enter at least two different ingot values to create an alloy.</p>

            <div id="alloyResult" class="alloy-result">
                <p><strong>Total Ingots:</strong> <span id="totalIngots">0</span></p>
                <p><strong>Composition:</strong> <span id="alloyComposition">-</span></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { getSequence } from './CalculateSequence.js';
        import ActionsEnum from './Actions.js';

        const actions = ActionsEnum.getComboActions();
        populateSelects('firstAction', 'firstImg');
        populateSelects('secondAction', 'secondImg');
        populateSelects('thirdAction', 'thirdImg');

        function populateSelects(selectId, imgId) {
            const select = document.getElementById(selectId)

            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.value;
                option.textContent = action.key;
                select.appendChild(option);
            });

            select.addEventListener("change", () => updateImage(selectId, imgId));
        }

        function updateImage(selectId, imgId) {
            const select = document.getElementById(selectId);
            const img = document.getElementById(imgId);
            const selectedKey = actions.find(action => action.value == select.value)?.key;

            if (selectedKey === "NONE") {
                img.style.visibility = "hidden";
            } else {
                img.src = `img/${selectedKey}.png`;
                img.style.visibility = "visible";
            }
        }

        document.getElementById("runSequence").addEventListener("click", () => {
            const firstAction = Number(document.getElementById('firstAction').value);
            const secondAction = Number(document.getElementById('secondAction').value);
            const thirdAction = Number(document.getElementById('thirdAction').value);

            let sequence = null;
            if (firstAction === 0) {
                sequence = getSequence(secondAction, thirdAction);
            } else {
                sequence = getSequence(firstAction, secondAction, thirdAction);
            }

            const formattedSequence = sequence.map(action => action.key).join(", ");
            document.getElementById("output").textContent = formattedSequence;
        });

        /* =========== TUTORIAL =========== */
        const tutorialBtn = document.getElementById("howToUseBtn");
        const modal = document.getElementById("tutorialModal");
        const closeBtn = document.querySelector(".close");

        window.addEventListener("load", () => {
            modal.classList.remove("show");
            modal.style.display = "none";
        });

        tutorialBtn.addEventListener("click", () => {
            modal.style.display = "flex";
            setTimeout(() => {
                modal.classList.add("show");
            }, 10);
        });

        closeBtn.addEventListener("click", () => {
            modal.classList.remove("show");
            
            setTimeout(() => {
                modal.style.display = "none";
            }, 300);
        });

        window.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.classList.remove("show");

                setTimeout(() => {
                    modal.style.display = "none";
                }, 300);
            }
        });
    </script>

    <script>
        document.getElementById("calculateAlloy").addEventListener("click", () => {
        const ingots = [
            parseInt(document.getElementById("ingot1").value) || 0,
            parseInt(document.getElementById("ingot2").value) || 0,
            parseInt(document.getElementById("ingot3").value) || 0,
            parseInt(document.getElementById("ingot4").value) || 0
        ];

        const validIngots = ingots.filter(value => value > 0);

        if (validIngots.length < 2) {
            errorMessage.style.display = "block";
            return;
        } else {
            errorMessage.style.display = "none";
        }

        const totalIngots = validIngots.reduce((sum, num) => sum + num, 0);

        const composition = validIngots
            .map(value => `${((value / totalIngots) * 100).toFixed(2)}%`)
            .join(" / ");

        document.getElementById("totalIngots").textContent = totalIngots;
        document.getElementById("alloyComposition").textContent = composition;
    });
    </script>
</body>
</html>