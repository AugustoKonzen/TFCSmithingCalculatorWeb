<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFC Smithing Calculator</title>
    <link rel="stylesheet" href="assets/styles/styles.css">
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
</head>
<body>
    <div class="global-container">
        <header class="site-header">
            <h1 data-i18n="global_title">TFC Smithing Calculator</h1>
        
            <div class="header-controls">
                <div class="language-dropdown">
                    <button id="languageButton" data-i18n="language_title">
                        Language <span class="globe">üåê</span>
                    </button>
                    <ul class="language-options">
                        <li data-lang="en_us">English</li>
                        <li data-lang="pt_br">Portugu√™s</li>
                        <li data-lang="es_es">Espa√±ol</li>
                    </ul>
                </div>
                <button id="howToUseBtn" class="tutorial-btn" data-i18n="tutorial.tutorial_btn">How to Use</button>
                <button id="themeToggle">
                    <img id="themeIcon" src="img/dark_theme.png" alt="Theme Icon">
                </button>
            </div>
        </header>

        <div id="tutorialModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 data-i18n="tutorial.title">How to Use</h2>
        
                <h3 data-i18n="tutorial.forge_section.title">Forging Process üî®</h3>
                <img src="img/start_forging.png" alt="Forging Start" class="tutorial-img">
                <p data-i18n="tutorial.forge_section.start_forging">
                    Before starting the forging process, you must align the two indicators shown in the red circles. 
                    Regardless of the selected sequence, forging will fail if these points are not aligned.
                </p>
        
                <img src="img/points_aligned.png" alt="Aligned Points" class="tutorial-img">
                <p data-i18n="tutorial.forge_section.alligned_points">
                    Once the two indicators are perfectly aligned, you can follow the calculated sequence step by step.
                    The system determines the optimal order of actions required to forge the item successfully.
                </p>
        
                <img src="img/output.png" alt="Calculated Sequence" class="tutorial-img">
                <p data-i18n="tutorial.forge_section.output">
                    Select the exact same actions as shown in the game, align the points, and apply the sequence 
                    generated by this system. If followed correctly, the forging process will succeed.
                </p>

                <div class="section-divider"></div>
        
                <h3 data-i18n="tutorial.alloy_section.title">Alloy Calculator üî•</h3>
                <img src="img/alloy_calculator.png" alt="Alloy Calculator" class="tutorial-img">
                <p data-i18n="tutorial.alloy_section.ores_description">
                    The Alloy Calculator helps you determine the total number of ingots produced and the metal composition 
                    based on the ingots you use in the melting process.
                </p>
                <p data-i18n="tutorial.alloy_section.important">
                    <strong>Important:</strong> This tool calculates <u>ingots</u>, not the raw ore pieces that you mine in the game.
                </p>
                <p data-i18n="tutorial.alloy_section.chunks_description">
                    When mining ores like Malachite (for copper), you obtain ore chunks, which can be Poor, Normal, or Rich quality.
                    Each piece provides different amounts of molten metal. The melting process requires gathering enough metal from 
                    these pieces to form full ingots.
                </p>
                <p data-i18n="tutorial.alloy_section.footer">
                    Use this calculator to determine the final ingot composition once you have the required number of ingots.
                </p>
            </div>
        </div>

        <h2 data-i18n="forge_section.title">Forging Process üî®</h2>

        <div class="container">
            <div class="action-box">
                <img src="" alt="" id="thirdImg">
                <select name="thirdAction" id="thirdAction"></select>
            </div>

            <div class="action-box">
                <img src="" alt="" id="secondImg">
                <select name="secondAction" id="secondAction"></select>
            </div>

            <div class="action-box">
                <img src="" alt="" id="firstImg">
                <select name="firstAction" id="firstAction"></select>
            </div>
        </div>

        <button id="runSequence" data-i18n="forge_section.calculate_sequence_btn">Calculate Sequence</button>
        <p id="forgeErrorMessage" class="error-message" data-i18n="forge_section.error_message">You must select at least two actions to calculate the forging sequence!</p>

        <pre id="output"></pre>

        <div class="section-divider"></div>

        <h2 data-i18n="alloy_section.title">Alloy Calculator üî•</h2>

        <div class="alloy-container">
            <h3 data-i18n="alloy_section.input_title">Metal Alloy Composition</h3>
            <p data-i18n="alloy_section.input_description">Enter the number of ingots used for each metal to calculate the alloy composition.</p>

            <div class="ingot-inputs">
                <div>
                    <label for="ingot1" data-i18n="alloy_section.ingot_1">Ingot 1:</label>
                    <input type="number" id="ingot1" min="0" value="0">
                </div>
                <div>
                    <label for="ingot2" data-i18n="alloy_section.ingot_2">Ingot 2:</label>
                    <input type="number" id="ingot2" min="0" value="0">
                </div>
                <div>
                    <label for="ingot3" data-i18n="alloy_section.ingot_3">Ingot 3:</label>
                    <input type="number" id="ingot3" min="0" value="0">
                </div>
                <div>
                    <label for="ingot4" data-i18n="alloy_section.ingot_4">Ingot 4:</label>
                    <input type="number" id="ingot4" min="0" value="0">
                </div>
            </div>
            
            <button id="calculateAlloy" data-i18n="alloy_section.calculate_alloy_btn">Calculate Alloy</button>
            <p id="errorMessage" class="error-message" data-i18n="alloy_section.error_message">Please enter at least two different ingot values to create an alloy.</p>

            <div id="alloyResult" class="alloy-result">
                <p data-i18n="alloy_section.result_total"><strong>Total Ingots:</strong> <span id="totalIngots">0</span></p>
                <p data-i18n="alloy_section.result_composition"><strong>Composition:</strong> <span id="alloyComposition">-</span></p>
            </div>
        </div>

        <button id="openFeedbackBtn" class="btn" data-i18n="feedback.openButton">
            Send a message
        </button>

        <dialog id="feedbackModal" class="feedback-modal" aria-labelledby="feedbackTitle">
        <form method="dialog" class="modal-header">
            <h2 id="feedbackTitle" data-i18n="feedback.title">Questions or Suggestions</h2>
            <button class="modal-close" aria-label="Close" title="Close">√ó</button>
        </form>

        <p class="modal-subtitle" data-i18n="feedback.subtitle">How would you like to send it?</p>

        <!-- Formul√°rio vis√≠vel por padr√£o -->
        <form id="feedbackForm" action="https://formspree.io/f/movlrvjq" method="POST" class="feedback-form" novalidate>
            <label class="field">
            <span data-i18n="feedback.form.email">Your email</span>
            <input type="email" name="email" placeholder="you@example.com" required>
            <small class="field-error" data-i18n="feedback.form.errors.email" hidden>Please enter a valid email.</small>
            </label>

            <label class="field">
            <span data-i18n="feedback.form.topic">Topic</span>
            <select name="topic" required>
                <option value="" selected disabled data-i18n="feedback.form.topics._select">Select‚Ä¶</option>
                <option value="question" data-i18n="feedback.form.topics.question">Question</option>
                <option value="suggestion" data-i18n="feedback.form.topics.suggestion">Suggestion</option>
                <option value="bug" data-i18n="feedback.form.topics.bug">Bug</option>
                <option value="translation" data-i18n="feedback.form.topics.translation">Translation</option>
            </select>
            <small class="field-error" data-i18n="feedback.form.errors.topic" hidden>Please choose a topic.</small>
            </label>

            <label class="field">
            <span data-i18n="feedback.form.message">Message</span>
            <textarea name="message" rows="5" required></textarea>
            <small class="field-error" data-i18n="feedback.form.errors.message" hidden>Please write your message.</small>
            </label>

            <!-- Anti-spam + contexto -->
            <input type="text" name="_gotcha" style="display:none">
            <input type="hidden" name="page_lang" id="feedbackLang">
            <input type="hidden" name="app_version" id="feedbackVersion" value="">

            <div class="form-actions">
            <button type="submit" class="btn" data-i18n="feedback.form.send">Send</button>
            <button type="button" class="btn btn-outline" id="cancelFormBtn" data-i18n="feedback.form.cancel">Cancel</button>
            </div>

            <p id="feedbackStatus" class="status" role="status" aria-live="polite"></p>
        </form>

        <!-- placeholders invis√≠veis para textos din√¢micos j√° traduzidos -->
        <p id="i18n_sending" class="visually-hidden" data-i18n="feedback.form.sending">Sending‚Ä¶</p>
        <p id="i18n_success" class="visually-hidden" data-i18n="feedback.form.success">Thanks! Received successfully.</p>
        <p id="i18n_error"   class="visually-hidden" data-i18n="feedback.form.error">Oops, something went wrong. Please try again later.</p>
        </dialog>
    </div>

    <script>
        (function () {
            const $ = (s) => document.querySelector(s);
            const modal = $('#feedbackModal');
            const openBtn = $('#openFeedbackBtn');
            const closeBtn = modal?.querySelector('.modal-close');
            const form = $('#feedbackForm');
            const cancelFormBtn = $('#cancelFormBtn');
            const statusEl = $('#feedbackStatus');
            const langEl = $('#feedbackLang');
            const versionEl = $('#feedbackVersion');

            // textos j√° traduzidos (seu script de i18n preencher√° esses elementos)
            const T = {
                sending: $('#i18n_sending'),
                success: $('#i18n_success'),
                error: $('#i18n_error')
            };

            // set context
            try {
                langEl.value = document.documentElement.lang || (window.currentLanguage || 'en');
                versionEl.value = (window.APP_VERSION || '');
            } catch (e) { }

            // abrir/fechar modal
            openBtn?.addEventListener('click', () => {
                if (typeof modal.showModal === 'function') modal.showModal();
                else modal.setAttribute('open', '');
                // limpar status/erros ao abrir
                clearStatus();
                clearErrors();
                form.reset();
            });
            closeBtn?.addEventListener('click', () => modal.close());
            modal?.addEventListener('click', (e) => { if (e.target === modal) modal.close(); });
            cancelFormBtn?.addEventListener('click', () => { form.reset(); clearStatus(); clearErrors(); modal.close(); });

            // valida√ß√£o de campos (HTML5 + mensagens)
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                clearStatus();
                clearErrors();

                const email = form.elements['email'];
                const topic = form.elements['topic'];
                const message = form.elements['message'];

                let valid = true;

                // e-mail
                if (!email.value || !email.checkValidity()) {
                    showError(email, email.closest('.field')?.querySelector('.field-error'));
                    valid = false;
                }
                // t√≥pico
                if (!topic.value) {
                    showError(topic, topic.closest('.field')?.querySelector('.field-error'));
                    valid = false;
                }
                // mensagem
                if (!message.value || !message.value.trim()) {
                    showError(message, message.closest('.field')?.querySelector('.field-error'));
                    valid = false;
                }

                if (!valid) return;

                setStatus(T.sending?.textContent || 'Sending‚Ä¶');
                try {
                    const r = await fetch(form.action, {
                        method: 'POST',
                        headers: { 'Accept': 'application/json' },
                        body: new FormData(form)
                    });
                    if (r.ok) {
                        form.reset();
                        setStatus(T.success?.textContent || 'Success.');
                    } else {
                        setStatus(T.error?.textContent || 'Error.');
                    }
                } catch {
                    setStatus(T.error?.textContent || 'Error.');
                }
            });

            function setStatus(text) { if (statusEl) statusEl.textContent = text; }
            function clearStatus() { if (statusEl) statusEl.textContent = ''; }
            function showError(input, errorEl) {
                input?.classList.add('field-invalid');
                if (errorEl) errorEl.hidden = false;
            }
            function clearErrors() {
                form.querySelectorAll('.field-invalid').forEach(el => el.classList.remove('field-invalid'));
                form.querySelectorAll('.field-error').forEach(el => el.hidden = true);
            }
        })();
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const themeToggle = document.getElementById("themeToggle");
            const themeIcon = document.getElementById("themeIcon");

            const savedTheme = localStorage.getItem("theme");

            if (savedTheme === "light") {
                document.body.classList.add("light-mode");
                themeIcon.src = "img/light_theme.png";
            } else {
                themeIcon.src = "img/dark_theme.png";
            }

            themeToggle.addEventListener("click", () => {
                document.body.classList.toggle("light-mode");

                if (document.body.classList.contains("light-mode")) {
                    themeIcon.src = "img/light_theme.png";
                    localStorage.setItem("theme", "light");
                } else {
                    themeIcon.src = "img/dark_theme.png";
                    localStorage.setItem("theme", "dark");
                }
            });
        });
    </script>

    <script>
        let currentLanguage = localStorage.getItem("language") || "en_us";

        document.addEventListener("DOMContentLoaded", () => {
            const langDropdown = document.querySelector(".language-dropdown");
            const langButton = document.getElementById("languageButton");
            const langOptions = document.querySelectorAll(".language-options li");

            langButton.addEventListener("click", () => {
                langDropdown.classList.toggle("open");
            });

            langOptions.forEach(option => {
                option.addEventListener("click", (event) => {
                    const selectedLang = event.target.dataset.lang;
                    loadLanguage(selectedLang);
                    langDropdown.classList.remove("open");
                });
            });

            document.addEventListener("click", (event) => {
                if (!langDropdown.contains(event.target)) {
                    langDropdown.classList.remove("open");
                }
            });
        });

        function getNestedTranslation(obj, path) {
            return path.split('.').reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : null, obj);
        }

        async function loadLanguage(lang) {
            try {
                const response = await fetch(`i18n/${lang}.json`);
                const translations = await response.json();

                if (translations) {
                    currentLanguage = lang;
                    localStorage.setItem("language", lang);

                    document.querySelectorAll("[data-i18n]").forEach(element => {
                        const key = element.dataset.i18n;
                        const translation = getNestedTranslation(translations, key);

                        if (translation) {
                            element.innerHTML = translation;
                        }
                    });

                    const languageSelector = document.getElementById("languageSelector");
                    if (languageSelector) {
                        languageSelector.value = lang;
                    }
                }
            } catch (error) {
                console.error("Error loading language file:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const languageSelector = document.getElementById("languageSelector");

            if (languageSelector) {
                languageSelector.addEventListener("change", (event) => {
                    loadLanguage(event.target.value);
                });
            }

            loadLanguage(currentLanguage);
        });
    </script>

    <script type="module">
        import { getSequence } from './assets/js/CalculateSequence.js';
        import ActionsEnum from './assets/js/Actions.js';

        const actions = ActionsEnum.getComboActions();
        populateSelects('firstAction', 'firstImg');
        populateSelects('secondAction', 'secondImg');
        populateSelects('thirdAction', 'thirdImg');

        function populateSelects(selectId, imgId) {
            const select = document.getElementById(selectId)

            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.value;
                option.textContent = action.key;
                select.appendChild(option);
            });

            select.addEventListener("change", () => updateImage(selectId, imgId));
        }

        function updateImage(selectId, imgId) {
            const select = document.getElementById(selectId);
            const img = document.getElementById(imgId);
            const selectedKey = actions.find(action => action.value == select.value)?.key;

            if (selectedKey === "NONE") {
                img.style.visibility = "hidden";
            } else {
                img.src = `img/${selectedKey}.png`;
                img.style.visibility = "visible";
            }
        }

        document.getElementById("runSequence").addEventListener("click", () => {
            const firstAction = Number(document.getElementById('firstAction').value);
            const secondAction = Number(document.getElementById('secondAction').value);
            const thirdAction = Number(document.getElementById('thirdAction').value);

            if (secondAction === 0 || thirdAction === 0) {
                forgeErrorMessage.style.display = "block";
                document.getElementById("output").textContent = '';
                return;
            } else {
                forgeErrorMessage.style.display = "none";
            }

            let sequence = null;
            if (firstAction === 0) {
                sequence = getSequence(secondAction, thirdAction);
            } else {
                sequence = getSequence(firstAction, secondAction, thirdAction);
            }

            const formattedSequence = sequence.map(action => action.key).join(", ");
            document.getElementById("output").textContent = formattedSequence;
        });
    </script>

    <script>
        const tutorialBtn = document.getElementById("howToUseBtn");
        const modal = document.getElementById("tutorialModal");
        const closeBtn = document.querySelector(".close");

        window.addEventListener("load", () => {
            modal.classList.remove("show");
            modal.style.display = "none";
        });

        tutorialBtn.addEventListener("click", () => {
            modal.style.display = "flex";
            setTimeout(() => {
                modal.classList.add("show");
            }, 10);
        });

        closeBtn.addEventListener("click", () => {
            modal.classList.remove("show");
            
            setTimeout(() => {
                modal.style.display = "none";
            }, 300);
        });

        window.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.classList.remove("show");

                setTimeout(() => {
                    modal.style.display = "none";
                }, 300);
            }
        });
    </script>

    <script>
        document.getElementById("calculateAlloy").addEventListener("click", () => {
        const ingots = [
            parseInt(document.getElementById("ingot1").value) || 0,
            parseInt(document.getElementById("ingot2").value) || 0,
            parseInt(document.getElementById("ingot3").value) || 0,
            parseInt(document.getElementById("ingot4").value) || 0
        ];

        const validIngots = ingots.filter(value => value > 0);

        if (validIngots.length < 2) {
            errorMessage.style.display = "block";
            document.getElementById("totalIngots").textContent = '0';
            document.getElementById("alloyComposition").textContent = '-';
            return;
        } else {
            errorMessage.style.display = "none";
        }

        const totalIngots = validIngots.reduce((sum, num) => sum + num, 0);

        const composition = validIngots
            .map(value => `${((value / totalIngots) * 100).toFixed(2)}%`)
            .join(" / ");

        document.getElementById("totalIngots").textContent = totalIngots;
        document.getElementById("alloyComposition").textContent = composition;
    });
    </script>
</body>
</html>
