<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actions Sequence</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
</head>
<body>
    <div class="global-container">
        <h1>TFC Smithing Calculator</h1>

        <button id="howToUseBtn" class="tutorial-btn">How to Use</button>

        <div id="tutorialModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>How to Use</h2>
        
                <img src="img/start_forging.png" alt="Forging Start" class="tutorial-img">
                <p>
                    Before starting the forging process, you must align the two indicators shown in the red circles. 
                    Regardless of the selected sequence, forging will fail if these points are not aligned.
                </p>
        
                <img src="img/points_aligned.png" alt="Aligned Points" class="tutorial-img">
                <p>
                    Once the two indicators are perfectly aligned, you can follow the calculated sequence step by step.
                    The system determines the optimal order of actions required to forge the item successfully.
                </p>
        
                <img src="img/output.png" alt="Calculated Sequence" class="tutorial-img">
                <p>
                    Select the exact same actions as shown in the game, align the points, and apply the sequence 
                    generated by this system. If followed correctly, the forging process will succeed.
                </p>
            </div>
        </div>

        <div class="container">
            <div class="action-box">
                <img src="" alt="" id="thirdImg">
                <select name="thirdAction" id="thirdAction"></select>
            </div>

            <div class="action-box">
                <img src="" alt="" id="secondImg">
                <select name="secondAction" id="secondAction"></select>
            </div>

            <div class="action-box">
                <img src="" alt="" id="firstImg">
                <select name="firstAction" id="firstAction"></select>
            </div>
        </div>

        <button id="runSequence">Get Sequence</button>
        <pre id="output"></pre>
    </div>

    <script type="module">
        import { getSequence } from './CalculateSequence.js';
        import ActionsEnum from './Actions.js';

        const actions = ActionsEnum.getComboActions();
        populateSelects('firstAction', 'firstImg');
        populateSelects('secondAction', 'secondImg');
        populateSelects('thirdAction', 'thirdImg');

        function populateSelects(selectId, imgId) {
            const select = document.getElementById(selectId)

            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.value;
                option.textContent = action.key;
                select.appendChild(option);
            });

            select.addEventListener("change", () => updateImage(selectId, imgId));
        }

        function updateImage(selectId, imgId) {
            const select = document.getElementById(selectId);
            const img = document.getElementById(imgId);
            const selectedKey = actions.find(action => action.value == select.value)?.key;

            if (selectedKey === "NONE") {
                img.style.visibility = "hidden";
            } else {
                img.src = `img/${selectedKey}.png`;
                img.style.visibility = "visible";
            }
        }

        document.getElementById("runSequence").addEventListener("click", () => {
            const firstAction = Number(document.getElementById('firstAction').value);
            const secondAction = Number(document.getElementById('secondAction').value);
            const thirdAction = Number(document.getElementById('thirdAction').value);

            let sequence = null;
            if (firstAction === 0) {
                sequence = getSequence(secondAction, thirdAction);
            } else {
                sequence = getSequence(firstAction, secondAction, thirdAction);
            }

            const formattedSequence = sequence.map(action => action.key).join(", ");
            document.getElementById("output").textContent = formattedSequence;
        });

        /* =========== TUTORIAL =========== */
        const tutorialBtn = document.getElementById("howToUseBtn");
        const modal = document.getElementById("tutorialModal");
        const closeBtn = document.querySelector(".close");

        window.addEventListener("load", () => {
            modal.classList.remove("show");
            modal.style.display = "none";
        });

        tutorialBtn.addEventListener("click", () => {
            modal.style.display = "flex";
            setTimeout(() => {
                modal.classList.add("show");
            }, 10);
        });

        closeBtn.addEventListener("click", () => {
            modal.classList.remove("show");
            
            setTimeout(() => {
                modal.style.display = "none";
            }, 300);
        });

        window.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.classList.remove("show");

                setTimeout(() => {
                    modal.style.display = "none";
                }, 300);
            }
        });
    </script>
</body>
</html>
